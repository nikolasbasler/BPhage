#!/bin/bash -l
#SBATCH --job-name="lifestyle_tool_test"
#SBATCH --cluster=genius
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=36
#SBATCH --mem-per-cpu=4G
#SBATCH --time=4:00:00
#SBATCH --account=lp_jm_virome_group
#SBATCH --output=slurm-%x_%j.out

###############################################################################

# Submit (from output/slurm_log)
# sbatch --export=ALL ../../scripts/HPC/lifestyle_tool_test.slrm

repo_location="$VSC_STAGING/BPhage"
threads=36

mkdir -p $VSC_SCRATCH/BPhage/lifestyle/tool_test
cd $VSC_SCRATCH/BPhage/lifestyle/tool_test

conda activate viper_bphage

cat $VSC_SCRATCH/BPhage/additional_datasets/virulent_*.fasta > all_seqs_completeness_100.fasta
seqkit grep -rp "full" $VSC_SCRATCH/BPhage/additional_datasets/Bueren_dc525_rd3.fna | sed 's/\..*//g' | sed 's/>/>Bueren_/g' >> all_seqs_completeness_100.fasta

awk '/^>/ { if (hdr) print seq; hdr=1; print; seq=""; next }
     { seq = seq $0 }
     END { if (hdr) print seq }' all_seqs_completeness_100.fasta > temp.all_seqs_singleline.fasta

grep ">" temp.all_seqs_singleline.fasta > temp.seq_IDs.txt
grep -v ">" temp.all_seqs_singleline.fasta > temp.seqs_only.txt

echo -e "0.250\t050\n0.167\t067\n0.083\t083" > temp.cuts.txt

rm -f temp.completeness_*.txt
while read line; do 
    while read remove; do
        seq_length=$(echo $line | wc -c)
        cut_frac=$(echo $remove | awk '{print $1}')
        cut_nt=$(echo "($cut_frac * $seq_length) + 1.5" | bc | cut -d. -f1)
        completeness=$(echo $remove | awk '{print $2}')
        echo $line | cut -c ${cut_nt}- | rev | cut -c ${cut_nt}- | rev >> temp.all_seqs_completeness_${completeness}.txt
    done < temp.cuts.txt
done < temp.seqs_only.txt

while read remove; do
    completeness=$(echo $remove | awk '{print $2}')
    paste temp.seq_IDs.txt temp.all_seqs_completeness_${completeness}.txt | sed 's/\t/\n/g' > all_seqs_completeness_${completeness}.fasta
done < temp.cuts.txt

for iteration in $(echo -e "$(cut -f2 temp.cuts.txt)\n100"); do
    
    # Bacphlip
    echo "Running Bacphlip for completeness ${iteration}"
    conda activate bacphlip
    cd $VSC_SCRATCH/BPhage/lifestyle/tool_test/
    bacphlip -i all_seqs_completeness_${iteration}.fasta --multi_fasta

    # Replidec
    echo "Running Replidec for completeness ${iteration}"
    conda activate replidec
    mkdir -p $VSC_SCRATCH/BPhage/lifestyle/tool_test/replidec/completeness_${iteration}
    cd $VSC_SCRATCH/BPhage/lifestyle/tool_test/replidec/completeness_${iteration}
    Replidec -p multiSeqEachAsOne -i ../../all_seqs_completeness_${iteration}.fasta -w replidec_run_${iteration} -t $threads
    cp replidec_run_${iteration}/BC_predict.summary ../../replidec_run_${iteration}_BC_predict.summary

done

cd $VSC_SCRATCH/BPhage/lifestyle/tool_test/
mkdir -p $repo_location/output/lifestyle/tool_test
cp replidec_run_*BC_predict.summary $repo_location/output/lifestyle/tool_test/
cp all_seqs_completeness_*.fasta.bacphlip $repo_location/output/lifestyle/tool_test/

echo "========================================================================"
duration=$SECONDS
printf 'Job finished in: %02d:%02d:%02d\n' $((duration/3600)) $((duration%3600/60)) $((duration%60))
