#!/bin/bash -l
#SBATCH --job-name="amg_vibrant"
#SBATCH --cluster=genius
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=12
#SBATCH --mem-per-cpu=4G
#SBATCH --time=1:00:00
#SBATCH --account=lp_jm_virome_group
#SBATCH --output=slurm-%x_%j.out

###############################################################################

# Submit (from output/slurm_log)
# sbatch --export=ALL ../../scripts/HPC/amg_vibrant.slrm

conda activate vibrant
repo_location="$VSC_STAGING/BPhage"

threads=12

mkdir -p $VSC_SCRATCH/BPhage/amg_vibrant/
cd $VSC_SCRATCH/BPhage/amg_vibrant/

zcat $repo_location/output/bphage_ALL_1kb_phages_refined_contigs.fasta.gz \
    $repo_location/output/bphage_ALL_1kb_picobirna.fasta.gz \
    $repo_location/output/bphage_ALL_1kb_unclassified_viruses.fasta.gz \
    > bphage_ALL_1kb_all_viruses.fasta

VIBRANT_run.py -i bphage_ALL_1kb_all_viruses.fasta -t ${threads} -folder bphage_all_viruses -virome \
    -d /staging/leuven/stg_00029/DB/vibrant/vibrant_20251007/databases \
    -m /staging/leuven/stg_00029/DB/vibrant/vibrant_20251007/files

echo -e "CDS\tstart\tend\tstrand\tdb_hit\tfunct" > bphage_all_viruses/VIBRANT_bphage_ALL_1kb_all_viruses/bphage_ALL_1kb_all_viruses.annotation.coords
grep ">" bphage_all_viruses/VIBRANT_bphage_ALL_1kb_all_viruses/VIBRANT_phages_bphage_ALL_1kb_all_viruses/bphage_ALL_1kb_all_viruses.phages_combined.faa | \
    cut -c 2- | sed -E 's/\(([0-9]+)\.\.([0-9]+)\)/\1\t\2/g' \
    >> bphage_all_viruses/VIBRANT_bphage_ALL_1kb_all_viruses/bphage_ALL_1kb_all_viruses.annotation.coords

mkdir -p $repo_location/output/amg_confirmation/
cp -r bphage_all_viruses/VIBRANT_bphage_ALL_1kb_all_viruses $repo_location/output/amg_confirmation/


echo "========================================================================"
duration=$SECONDS
printf 'Job finished in: %02d:%02d:%02d\n' $((duration/3600)) $((duration%3600/60)) $((duration%60))
